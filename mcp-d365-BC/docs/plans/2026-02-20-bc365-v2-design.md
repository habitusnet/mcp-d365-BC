# bc365 v2 — Design Document

**Date:** 2026-02-20
**Status:** Approved
**Scope:** Internal (Habitusnet) first

---

## Problem Statement

bc365 v1 is a thin configuration layer — it wires two upstream npm packages into Claude and ships skills and commands. It has three significant weaknesses:

1. **No supply chain control.** `@demiliani/d365bc-admin-mcp` and `@knowall-ai/mcp-business-central` are pulled directly from their publishers' npm builds. Habitusnet has no visibility into what changed between releases, no security scanning gate, and no ability to hold back a bad update.
2. **Brittle onboarding.** Users must manually look up tenant IDs, environment names, and company GUIDs and paste them into `.mcp.json`. This is error-prone and requires BC knowledge before the tool can help with BC.
3. **Distribution requires cloning a repo.** There is no package — setup means `git clone` followed by `bash setup.sh`, which is fragile (bash dependency, npm executable-bit bug, no versioning).

v2 addresses all three.

---

## Goals

- Controlled dependency pipeline: all upstream code passes through Habitusnet's security gate before running
- Automated upstream monitoring: new releases and CVEs surface as PRs, not surprises
- One-command install: `npm install -g @habitusnet/bc365`
- One-command onboarding: `bc365 onboard` — sign in once, everything else is discovered automatically
- Multi-tenant ready: Habitusnet manages multiple client BC tenants from a single authenticated session

## Non-Goals

- Public distribution (v2 is internal; public release is a future consideration)
- Custom BC extensions or AL development tooling
- Replacing the BC web client for data entry

---

## Architecture

### Three repos, one pipeline

```
habitusnet/d365bc-admin-mcp          habitusnet/mcp-business-central
  (mirror of @demiliani upstream)      (mirror of @knowall-ai upstream)
         │                                        │
         │  automated sync + PR gate              │  automated sync + PR gate
         │                                        │
         └──────────────┬─────────────────────────┘
                        │  npm dependency
                habitusnet/mcp-d365-BC
                  (@habitusnet/bc365 npm package)
                        │
                        │  npm install -g
                   End user / Claude
```

---

## Component 1 — Vendored mirror repos

### Repos

- `habitusnet/d365bc-admin-mcp` — mirrors `demiliani/d365bc-admin-mcp`
- `habitusnet/mcp-business-central` — mirrors `knowall-ai/mcp-business-central`

### Automation: `upstream-watch.yml` (daily schedule)

```yaml
on:
  schedule:
    - cron: '0 8 * * *'   # 08:00 UTC daily

steps:
  - Read .upstream-version from repo
  - Call GitHub API: GET /repos/{owner}/{repo}/releases/latest
  - Compare tags
  - If newer:
      - Copy upstream source tree into repo
      - Run: npm audit --audit-level=high
      - Run: CodeQL analysis
      - Run: license-checker (SPDX allow-list)
      - Post changelog diff as PR comment
      - Open PR: "chore: sync upstream vX.Y.Z"
      - Assign to @habitusnet/bc365-maintainers for review
```

### PR gate requirements (branch protection)

- `npm audit` must pass (no high or critical CVEs)
- CodeQL must pass
- At least one maintainer approval
- No merge without all checks green

### On merge: `publish.yml`

```yaml
steps:
  - Bump package version to match upstream tag
  - npm publish --access public (or restricted for private)
  - Update .upstream-version
  - Open dependency-bump PR on habitusnet/mcp-d365-BC
```

### `.upstream-version` file

A single-line file at repo root containing the last successfully merged upstream tag, e.g. `1.1.1`. This is the source of truth for the daily watch job.

---

## Component 2 — `@habitusnet/bc365` npm package

### Repo structure

```
habitusnet/mcp-d365-BC/
├── package.json
├── bin/
│   └── bc365.js              ← CLI entry point
├── lib/
│   ├── onboard.js            ← tenant discovery and .mcp.json generation
│   ├── auth.js               ← Entra ID device code / token cache
│   └── mcp-config.js         ← MCP server definitions
├── skills/                   ← unchanged from v1
├── commands/                 ← unchanged from v1
├── .github/
│   └── workflows/
│       ├── ci.yml            ← audit + CodeQL on every PR
│       ├── upstream-watch.yml ← watches mirror repos for new releases
│       └── publish.yml       ← publishes to npm on main merge
├── README.md
└── SETUP.md
```

### `package.json` (key fields)

```json
{
  "name": "@habitusnet/bc365",
  "version": "2.0.0",
  "bin": { "bc365": "./bin/bc365.js" },
  "dependencies": {
    "@habitusnet/d365bc-admin-mcp": "^1.1.1",
    "@habitusnet/mcp-business-central": "^1.0.0"
  }
}
```

Dependencies reference Habitusnet's vendored packages — never upstream directly.

### CLI commands

```bash
bc365 setup       # check prerequisites (Node, auth)
bc365 onboard     # full tenant discovery → writes .mcp.json
bc365 switch      # switch between saved tenant profiles
bc365 check       # check installed vs latest versions of all components
bc365 update      # pull latest vendored packages
```

---

## Component 3 — Entra ID app registration

### App: `bc365` (registered in Habitusnet tenant, multi-tenant enabled)

| Setting | Value |
|---------|-------|
| Display name | bc365 |
| Supported account types | Accounts in any organizational directory |
| Redirect URI | `http://localhost` (device code flow) |

### Delegated API permissions

| API | Permission | Purpose |
|-----|-----------|---------|
| Dynamics ERP | `user_impersonation` | BC API access |
| Microsoft Graph | `User.Read` | Current user UPN and tenant ID |
| Microsoft Graph | `Directory.Read.All` | Enumerate accessible tenants |

### Token management

- Device code flow on first run — opens browser, user signs in with M365 credentials
- Token cached in OS keychain (macOS Keychain / Windows Credential Manager) via `keytar`
- Silent refresh on subsequent runs
- `az login` supported as fallback for environments where keychain access is unavailable

---

## Component 4 — Smart tenant onboarding

### `bc365 onboard` flow

```
1. Auth
   → Check keychain for cached token
   → If missing: launch device code flow (browser sign-in)
   → Resolve tenantId, upn from Graph /me

2. Tenant discovery
   → If Habitusnet manages multiple client tenants:
     Graph API → list accessible tenants
     Prompt: "Which tenant? [Contoso / Fabrikam / ...]"
   → --tenant <id> flag skips this step

3. Environment discovery
   → BC admin API → list environments
   → If multiple: prompt "Which environment? [Production / Sandbox-UAT / ...]"

4. Company discovery
   → BC data API → list companies in chosen environment
   → If multiple: prompt "Which company? [Fabrikam Ltd / Fabrikam US Inc / ...]"

5. Permission check
   → OData query for current user's BC permission sets
   → Report present and missing permissions:
     ✓  BC User
     ✓  BC Accountant
     ⚠  D365 BUS FULL ACCESS — missing (write operations will return 403)

6. Write .mcp.json
   → BC_URL_SERVER, BC_COMPANY, BC_AUTH_TYPE, BC_CLIENT_ID populated automatically

7. Summary output
   ✓ Tenant:      contoso.onmicrosoft.com (3f2a...)
   ✓ Environment: Production (v24.3)
   ✓ Company:     Fabrikam Ltd (a1b2...)
   ✓ Auth:        bc365 app (token cached)
   ⚠ Write access: D365 BUS FULL ACCESS not assigned — read-only mode
   → Configuration written to .mcp.json
```

### `bc365 switch` — multi-tenant profile management

Saved profiles stored in `~/.bc365/profiles.json`. Each profile captures the full resolved config for a tenant+environment+company combination. `bc365 switch` lists profiles and updates `.mcp.json` to point at the selected one — no re-authentication required.

---

## Versioning and release flow

```
Upstream releases vX.Y.Z
        ↓
upstream-watch.yml opens sync PR on habitusnet/d365bc-admin-mcp
        ↓
CI scans pass, maintainer approves, PR merges
        ↓
publish.yml publishes @habitusnet/d365bc-admin-mcp@X.Y.Z to npm
publish.yml opens dependency-bump PR on habitusnet/mcp-d365-BC
        ↓
bc365 CI runs (audit against new dep, integration smoke test)
Maintainer approves, PR merges
        ↓
publish.yml publishes @habitusnet/bc365@2.x.y to npm
```

Semantic versioning for bc365 itself:
- Patch: dependency bumps with no API changes
- Minor: new commands or skills
- Major: breaking changes to CLI or MCP config format

---

## Migration from v1

| v1 | v2 |
|----|-----|
| `git clone` + `bash setup.sh` | `npm install -g @habitusnet/bc365` |
| Manual `.mcp.json` editing | `bc365 onboard` |
| `az login` required | Browser sign-in via bc365 Entra app |
| Upstream packages pulled directly | Vendored + scanned packages only |
| No version monitoring | Daily upstream watch + PR gate |

Existing `.mcp.json` files remain valid — v2 is backwards compatible for users who keep manual configs.

---

## Open questions

1. **npm registry**: publish to public npm (`@habitusnet/` org) or GitHub Packages (private)? GitHub Packages requires auth for install, which conflicts with clean onboarding. Recommendation: public npm with scoped package.
2. **Windows support**: `bin/bc365.js` replaces `setup.sh` for cross-platform support, but the admin MCP binary is currently macOS-only (`osx-arm64`). Upstream issue — track in vendored repo.
3. **Entra app consent**: multi-tenant app requires admin consent in each client tenant for `Directory.Read.All`. Document this as a one-time setup step per client.
